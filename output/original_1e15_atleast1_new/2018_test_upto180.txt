/mnt/phd/jihu/opioid/Code/risk_test.py:33: DtypeWarning: Columns (2) have mixed types. Specify dtype option on import or set low_memory=False.
  FULL = pd.read_csv(file_path, delimiter=",", dtype={'concurrent_MME': float,
Start testing, file saved with setting tag _2018_test_upto180_upto180

{'intercept': -7, 'conditions': ['prescriber_yr_avg_days_quartile', 'age', 'concurrent_MME', 'HMFO', 'Medicare', 'pharmacy_yr_avg_days_quartile'], 'cutoffs': ['4', 30, 30, 1, 1, '4'], 'scores': [3, 2, 1, 1, 1, 1]}
['patient_id', 'patient_gender', 'patient_zip', 'quantity', 'days_supply', 'date_filled', 'daily_dose', 'total_dose', 'max_dose', 'age', 'concurrent_MME', 'concurrent_methadone_MME', 'num_prescribers_past180', 'num_pharmacies_past180', 'consecutive_days', 'concurrent_benzo', 'concurrent_benzo_same', 'concurrent_benzo_diff', 'days_to_long_term', 'long_term_180', 'num_prior_prescriptions', 'num_prior_prescriptions_past180', 'num_prior_prescriptions_past90', 'num_prior_prescriptions_past30', 'switch_drug', 'switch_payment', 'ever_switch_drug', 'ever_switch_payment', 'dose_diff', 'concurrent_MME_diff', 'quantity_diff', 'days_diff', 'avgMME_past180', 'avgDays_past180', 'avgMME_past90', 'avgDays_past90', 'avgMME_past30', 'avgDays_past30', 'HMFO', 'Codeine_MME', 'Hydrocodone_MME', 'Oxycodone_MME', 'Morphine_MME', 'Hydromorphone_MME', 'Methadone_MME', 'Fentanyl_MME', 'Oxymorphone_MME', 'gap', 'num_prior_prescriptions_benzo_past180', 'num_prior_prescriptions_benzo_past90', 'num_prior_prescriptions_benzo_past30', 'patient_HPIQuartile', 'prescriber_HPIQuartile', 'pharmacy_HPIQuartile', 'zip_pop', 'zip_pop_density', 'median_household_income', 'family_poverty_pct', 'unemployment_pct', 'patient_zip_yr_num_prescriptions', 'patient_zip_yr_num_patients', 'patient_zip_yr_num_pharmacies', 'patient_zip_yr_avg_MME', 'patient_zip_yr_avg_days', 'patient_zip_yr_avg_quantity', 'patient_zip_yr_num_prescriptions_quartile', 'patient_zip_yr_num_patients_quartile', 'patient_zip_yr_num_pharmacies_quartile', 'patient_zip_yr_avg_MME_quartile', 'patient_zip_yr_avg_days_quartile', 'patient_zip_yr_avg_quantity_quartile', 'prescriber_yr_num_prescriptions', 'prescriber_yr_num_patients', 'prescriber_yr_num_pharmacies', 'prescriber_yr_avg_MME', 'prescriber_yr_avg_days', 'prescriber_yr_avg_quantity', 'prescriber_yr_num_prescriptions_quartile', 'prescriber_yr_num_patients_quartile', 'prescriber_yr_num_pharmacies_quartile', 'prescriber_yr_avg_MME_quartile', 'prescriber_yr_avg_days_quartile', 'prescriber_yr_avg_quantity_quartile', 'pharmacy_yr_num_prescriptions', 'pharmacy_yr_num_patients', 'pharmacy_yr_num_prescribers', 'pharmacy_yr_avg_MME', 'pharmacy_yr_avg_days', 'pharmacy_yr_avg_quantity', 'pharmacy_yr_num_prescriptions_quartile', 'pharmacy_yr_num_patients_quartile', 'pharmacy_yr_num_prescribers_quartile', 'pharmacy_yr_avg_MME_quartile', 'pharmacy_yr_avg_days_quartile', 'pharmacy_yr_avg_quantity_quartile', 'Codeine', 'Hydrocodone', 'Oxycodone', 'Morphine', 'Hydromorphone', 'Methadone', 'Fentanyl', 'Oxymorphone', 'Medicaid', 'CommercialIns', 'Medicare', 'CashCredit', 'MilitaryIns', 'WorkersComp', 'Other', 'IndianNation', 'zip_pop_density_quartile', 'median_household_income_quartile', 'family_poverty_pct_quartile', 'unemployment_pct_quartile', 'patient_zip_yr_num_prescriptions_per_pop', 'patient_zip_yr_num_patients_per_pop', 'patient_zip_yr_num_prescriptions_per_pop_quartile', 'patient_zip_yr_num_patients_per_pop_quartile']
Calibration curve saved as Calibration_2018_test_upto180_upto180.pdf

ROC curve saved as ROC_2018_test_upto180_upto180.pdf

Threshold: 1.88
Confusion Matrix:
[[7147103       0]
 [ 610360       0]]

Threshold: 0.88
Confusion Matrix:
[[7145589    1514]
 [ 607289    3071]]

Threshold: 0.73
Confusion Matrix:
[[7109918   37185]
 [ 563631   46729]]

Threshold: 0.50
Confusion Matrix:
[[6863678  283425]
 [ 388820  221540]]

Threshold: 0.27
Confusion Matrix:
[[6344710  802393]
 [ 207680  402680]]

Threshold: 0.12
Confusion Matrix:
[[5975841 1171262]
 [ 139882  470478]]

Threshold: 0.05
Confusion Matrix:
[[5214072 1933031]
 [  95653  514707]]

Threshold: 0.02
Confusion Matrix:
[[2581778 4565325]
 [  28867  581493]]

Threshold: 0.01
Confusion Matrix:
[[ 902918 6244185]
 [   2534  607826]]

Threshold: 0.00
Confusion Matrix:
[[ 440385 6706718]
 [   1052  609308]]

Threshold: 0.00
Confusion Matrix:
[[      0 7147103]
 [      0  610360]]

Test done!

                    Value
Accuracy           0.9133
Recall              0.363
Precision          0.4387
ROC AUC            0.8535
PR AUC             0.3316
Calibration error  0.0147
       Prob  Num_presc       TN      FP      FN      TP  Accuracy  \
0  0.000911     441437   440385       0    1052       0    0.9976   
1  0.002473     464015   462533       0    1482       0    0.9968   
2  0.006693    1705193  1678860       0   26333       0    0.9846   
3  0.017986    2699080  2632294       0   66786       0    0.9753   
4  0.047426     805998   761769       0   44229       0    0.9451   
5  0.119203     436667   368869       0   67798       0    0.8447   
6  0.268941     700108   518968       0  181140       0    0.7413   
7  0.500000     421051        0  246240       0  174811    0.4152   
8  0.731059      79329        0   35671       0   43658    0.5503   
9  0.880797       4585        0    1514       0    3071    0.6698   

   Observed Risk  Num_patients  Num_longterm  
0       0.002383        394370          1231  
1       0.003194        397225          1635  
2       0.015443       1336656         29348  
3       0.024744       1833588         69653  
4       0.054875        537403         45188  
5       0.155262        308275         69651  
6       0.258732        473821        176105  
7       0.415178        292163        161846  
8       0.550341         59290         40600  
9       0.669793          3778          2919  
