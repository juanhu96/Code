/mnt/phd/jihu/opioid/Code/risk_train.py:71: DtypeWarning: Columns (2) have mixed types. Specify dtype option on import or set low_memory=False.
  FULL = pd.read_csv(file_path, delimiter=",", dtype={'concurrent_MME': float,
Start single training, file saved with setting tag _single_p5_f8_median_nodrug_featureatmostonecutoff_group_essential1.0

/export/storage_cures/CURES/Processed/FULL_OPIOID_2018_INPUT.csv
FULL_2018_Explore_STUMPS_median_
Finished importing STUMPS, with shape (6263383, 146)

Single cutoffs:
['concurrent_MME10', 'concurrent_MME15', 'concurrent_MME20', 'concurrent_MME25', 'concurrent_MME30', 'concurrent_MME35', 'concurrent_MME40', 'concurrent_MME45', 'concurrent_MME50', 'concurrent_MME75', 'concurrent_MME100', 'concurrent_MME200', 'concurrent_MME300']
['num_prescribers_past1802', 'num_prescribers_past1803']
['num_pharmacies_past1802', 'num_pharmacies_past1803']
['concurrent_benzo1']
['Medicaid']
[]
['Medicare']
['CashCredit']
[]
[]
[]
[]
['num_prior_prescriptions1']
['diff_MME1']
['diff_days1']
['switch_drug']
['switch_payment']
['ever_switch_drug']
['ever_switch_payment']
['age30', 'age40', 'age50', 'age60', 'age70', 'age80']
['patient_gender']
[]
[]
['patient_zip_yr_num_prescriptions_per_pop_quartile_0.0', 'patient_zip_yr_num_prescriptions_per_pop_quartile_1.0']
['patient_zip_yr_num_patients_per_pop_quartile_0.0', 'patient_zip_yr_num_patients_per_pop_quartile_1.0']
['prescriber_yr_num_prescriptions_quartile_0.0', 'prescriber_yr_num_prescriptions_quartile_1.0']
['prescriber_yr_num_patients_quartile_0.0', 'prescriber_yr_num_patients_quartile_1.0']
['prescriber_yr_num_pharmacies_quartile_0.0', 'prescriber_yr_num_pharmacies_quartile_1.0']
['prescriber_yr_avg_MME_quartile_0.0', 'prescriber_yr_avg_MME_quartile_1.0']
['prescriber_yr_avg_days_quartile_0.0', 'prescriber_yr_avg_days_quartile_1.0']
['pharmacy_yr_num_prescriptions_quartile_0.0', 'pharmacy_yr_num_prescriptions_quartile_1.0']
['pharmacy_yr_num_patients_quartile_0.0', 'pharmacy_yr_num_patients_quartile_1.0']
['pharmacy_yr_num_prescribers_quartile_0.0', 'pharmacy_yr_num_prescribers_quartile_1.0']
['pharmacy_yr_avg_MME_quartile_0.0', 'pharmacy_yr_avg_MME_quartile_1.0']
['pharmacy_yr_avg_days_quartile_0.0', 'pharmacy_yr_avg_days_quartile_1.0']
['patient_HPIQuartile_0.0', 'patient_HPIQuartile_1.0']
['zip_pop_density_quartile_0.0', 'zip_pop_density_quartile_1.0']
['median_household_income_quartile_0.0', 'median_household_income_quartile_1.0']
['family_poverty_pct_quartile_0.0', 'family_poverty_pct_quartile_1.0']
['unemployment_pct_quartile_0.0', 'unemployment_pct_quartile_1.0']
['Medicaid', 'Medicare', 'CashCredit']
['patient_zip_yr_num_prescriptions_per_pop_quartile_0.0', 'patient_zip_yr_num_prescriptions_per_pop_quartile_1.0', 'patient_zip_yr_num_patients_per_pop_quartile_0.0', 'patient_zip_yr_num_patients_per_pop_quartile_1.0']
['prescriber_yr_num_prescriptions_quartile_0.0', 'prescriber_yr_num_prescriptions_quartile_1.0', 'prescriber_yr_num_patients_quartile_0.0', 'prescriber_yr_num_patients_quartile_1.0', 'prescriber_yr_num_pharmacies_quartile_0.0', 'prescriber_yr_num_pharmacies_quartile_1.0', 'prescriber_yr_avg_MME_quartile_0.0', 'prescriber_yr_avg_MME_quartile_1.0', 'prescriber_yr_avg_days_quartile_0.0', 'prescriber_yr_avg_days_quartile_1.0']
['pharmacy_yr_num_prescriptions_quartile_0.0', 'pharmacy_yr_num_prescriptions_quartile_1.0', 'pharmacy_yr_num_patients_quartile_0.0', 'pharmacy_yr_num_patients_quartile_1.0', 'pharmacy_yr_num_prescribers_quartile_0.0', 'pharmacy_yr_num_prescribers_quartile_1.0', 'pharmacy_yr_avg_MME_quartile_0.0', 'pharmacy_yr_avg_MME_quartile_1.0', 'pharmacy_yr_avg_days_quartile_0.0', 'pharmacy_yr_avg_days_quartile_1.0']
['patient_HPIQuartile_0.0', 'patient_HPIQuartile_1.0', 'zip_pop_density_quartile_0.0', 'zip_pop_density_quartile_1.0', 'median_household_income_quartile_0.0', 'median_household_income_quartile_1.0', 'family_poverty_pct_quartile_0.0', 'family_poverty_pct_quartile_1.0', 'unemployment_pct_quartile_0.0', 'unemployment_pct_quartile_1.0']
------------------------------------------------------------
Two cutoffs
Essential cutoffs with lower bound: 1.0
['concurrent_MME10', 'concurrent_MME15', 'concurrent_MME20', 'concurrent_MME25', 'concurrent_MME30', 'concurrent_MME35', 'concurrent_MME40', 'concurrent_MME45', 'concurrent_MME50', 'concurrent_MME75', 'concurrent_MME100', 'concurrent_MME200', 'concurrent_MME300', 'num_prescribers_past1802', 'num_prescribers_past1803', 'num_pharmacies_past1802', 'num_pharmacies_past1803', 'concurrent_benzo1', 'num_prior_prescriptions1', 'diff_MME1', 'diff_days1', 'age30', 'age40', 'age50', 'age60', 'age70', 'age80', 'Medicaid', 'Medicare', 'CashCredit', 'switch_drug', 'switch_payment', 'ever_switch_drug', 'ever_switch_payment', 'patient_gender', 'patient_HPIQuartile_0.0', 'patient_HPIQuartile_1.0', 'patient_zip_yr_num_prescriptions_per_pop_quartile_0.0', 'patient_zip_yr_num_prescriptions_per_pop_quartile_1.0', 'patient_zip_yr_num_patients_per_pop_quartile_0.0', 'patient_zip_yr_num_patients_per_pop_quartile_1.0', 'prescriber_yr_num_prescriptions_quartile_0.0', 'prescriber_yr_num_prescriptions_quartile_1.0', 'prescriber_yr_num_patients_quartile_0.0', 'prescriber_yr_num_patients_quartile_1.0', 'prescriber_yr_num_pharmacies_quartile_0.0', 'prescriber_yr_num_pharmacies_quartile_1.0', 'prescriber_yr_avg_MME_quartile_0.0', 'prescriber_yr_avg_MME_quartile_1.0', 'prescriber_yr_avg_days_quartile_0.0', 'prescriber_yr_avg_days_quartile_1.0', 'pharmacy_yr_num_prescriptions_quartile_0.0', 'pharmacy_yr_num_prescriptions_quartile_1.0', 'pharmacy_yr_num_patients_quartile_0.0', 'pharmacy_yr_num_patients_quartile_1.0', 'pharmacy_yr_num_prescribers_quartile_0.0', 'pharmacy_yr_num_prescribers_quartile_1.0', 'pharmacy_yr_avg_MME_quartile_0.0', 'pharmacy_yr_avg_MME_quartile_1.0', 'pharmacy_yr_avg_days_quartile_0.0', 'pharmacy_yr_avg_days_quartile_1.0', 'zip_pop_density_quartile_0.0', 'zip_pop_density_quartile_1.0', 'median_household_income_quartile_0.0', 'median_household_income_quartile_1.0', 'family_poverty_pct_quartile_0.0', 'family_poverty_pct_quartile_1.0', 'unemployment_pct_quartile_0.0', 'unemployment_pct_quartile_1.0']
------------------------------------------------------------
setting c0_value = 0.0 for (Intercept) to ensure that intercept is not penalized
08/08/24 @ 04:55 PM | switching loss computation from lookup to weighted
08/08/24 @ 04:56 PM | ------------------------------------------------------------
08/08/24 @ 04:56 PM | runnning initialization procedure
08/08/24 @ 04:56 PM | ------------------------------------------------------------
08/08/24 @ 04:59 PM | CPA produced 2 cuts
08/08/24 @ 04:59 PM | running naive rounding on 4 solutions
08/08/24 @ 04:59 PM | best objective value: 0.4222
08/08/24 @ 04:59 PM | rounding produced 0 integer solutions
08/08/24 @ 04:59 PM | running sequential rounding on 4 solutions
08/08/24 @ 04:59 PM | best objective value: 0.4222
08/08/24 @ 04:59 PM | sequential rounding produced 0 integer solutions
08/08/24 @ 04:59 PM | initialization produced 0 feasible solutions
08/08/24 @ 04:59 PM | ------------------------------------------------------------
08/08/24 @ 04:59 PM | completed initialization procedure
08/08/24 @ 04:59 PM | ------------------------------------------------------------
08/08/24 @ 04:59 PM | switching loss computation from lookup to weighted
register_callback

08/08/24 @ 04:59 PM | adding 463 initial cuts
/mnt/phd/jihu/opioid/Code/risk_test.py:36: DtypeWarning: Columns (2) have mixed types. Specify dtype option on import or set low_memory=False.
  FULL = pd.read_csv(file_path, delimiter=",", dtype={'concurrent_MME': float,
+-----------------------------------------------+------------------+-----------+
| Pr(Y = +1) = 1.0/(1.0 + exp(-(-7 + score)))   |                  |           |
| ============================================= | ================ | ========= |
| num_prior_prescriptions1                      |         2 points |   + ..... |
| prescriber_yr_avg_days_quartile_1.0           |         2 points |   + ..... |
| concurrent_MME40                              |         1 points |   + ..... |
| age30                                         |         1 points |   + ..... |
| Medicaid                                      |         1 points |   + ..... |
| pharmacy_yr_avg_days_quartile_1.0             |         1 points |   + ..... |
| ============================================= | ================ | ========= |
| ADD POINTS FROM ROWS 1 to 6                   |            SCORE |   = ..... |
+-----------------------------------------------+------------------+-----------+
-7 ['num_prior_prescriptions1', 'prescriber_yr_avg_days_quartile_1.0', 'concurrent_MME40', 'age30', 'Medicaid', 'pharmacy_yr_avg_days_quartile_1.0'] [2. 2. 1. 1. 1. 1.]
{'intercept': -7, 'conditions': ['num_prior_prescriptions', 'prescriber_yr_avg_days_quartile', 'concurrent_MME', 'age', 'Medicaid', 'pharmacy_yr_avg_days_quartile'], 'cutoffs': [1, '1', 40, 30, 1, '1'], 'scores': [2, 2, 1, 1, 1, 1]}
Finished riskSLIM in 2890.8 seconds

                         Train
Train accuracy           0.897
Train Recall             0.272
Train Precision          0.443
Train ROC AUC            0.853
Train PR AUC             0.318
Train Calibration error  0.014
Start testing with table:
Intercept: -7

 - Condition: num_prior_prescriptions, Cutoff: 1, Score: 2
 - Condition: prescriber_yr_avg_days_quartile, Cutoff: 1, Score: 2
 - Condition: concurrent_MME, Cutoff: 40, Score: 1
 - Condition: age, Cutoff: 30, Score: 1
 - Condition: Medicaid, Cutoff: 1, Score: 1
 - Condition: pharmacy_yr_avg_days_quartile, Cutoff: 1, Score: 1
WARNING: Encoding quartile values to binary

0: Accuracy = 0.897, ROC AUC = 0.848, Calibration = 0.016
1: Accuracy = 0.899, ROC AUC = 0.852, Calibration = 0.015
----------------------------------------------------------------------------------------------------
Total prescriptions from true positive patients: 
 (273366, 122)
----------------------------------------------------------------------------------------------------
Proportion of LT users detected within a month: 0.5132485766876418
1
{'test_accuracy': 0.9742916696995163, 'test_roc_auc': 0.8352398251743013, 'test_pr_auc': 0.09380196115403927, 'test_calibration_error': 0.00721650293531091}
2
{'test_accuracy': 0.859944677836389, 'test_roc_auc': 0.7588716441721288, 'test_pr_auc': 0.20212037579099557, 'test_calibration_error': 0.07133989806956076}
3
{'test_accuracy': 0.774821674667959, 'test_roc_auc': 0.7140934833374522, 'test_pr_auc': 0.3346864115564778, 'test_calibration_error': 0.02843968557763149}


Test done!

                   Value
Accuracy           0.898
Recall             0.253
Precision          0.448
ROC AUC             0.85
PR AUC             0.313
Calibration error  0.015
       Prob  Num_presc       TN      FP      FN      TP  Accuracy  \
0  0.000911     205806   205715       0      91       0    0.9996   
1  0.002473    1148707  1145925       0    2782       0    0.9976   
2  0.006693    1039527  1033982       0    5545       0    0.9947   
3  0.017986     966157   935924       0   30233       0    0.9687   
4  0.047426    1037952   965929       0   72023       0    0.9306   
5  0.119203     713732   596352       0  117380       0    0.8355   
6  0.268941     857928   633350       0  224578       0    0.7382   
7  0.500000     330357        0  183770       0  146587    0.4437   
8  0.731059      12672        0    5731       0    6941    0.5477   

   Observed Risk  Num_patients  Num_longterm  
0       0.000442        205806           136  
1       0.002422       1148707          3985  
2       0.005334       1033185          7359  
3       0.031292        845669         27426  
4       0.069390        862202         59793  
5       0.164459        472005         58477  
6       0.261768        410665         71376  
7       0.443723        153010         46140  
8       0.547743          6320          2643  
