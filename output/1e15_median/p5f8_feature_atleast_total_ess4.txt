/mnt/phd/jihu/opioid/Code/risk_train.py:71: DtypeWarning: Columns (2) have mixed types. Specify dtype option on import or set low_memory=False.
  FULL = pd.read_csv(file_path, delimiter=",", dtype={'concurrent_MME': float,
Start single training, file saved with setting tag _single_p5_f8_median_featureatleast_total_essential4.0

/export/storage_cures/CURES/Processed/FULL_OPIOID_2018_INPUT.csv
FULL_2018_Explore_STUMPS_median_
Finished importing STUMPS, with shape (6263383, 146)

Single cutoffs:
['concurrent_MME10', 'concurrent_MME15', 'concurrent_MME20', 'concurrent_MME25', 'concurrent_MME30', 'concurrent_MME35', 'concurrent_MME40', 'concurrent_MME45', 'concurrent_MME50', 'concurrent_MME75', 'concurrent_MME100', 'concurrent_MME200', 'concurrent_MME300']
['num_prescribers_past1802', 'num_prescribers_past1803']
['num_pharmacies_past1802', 'num_pharmacies_past1803']
['concurrent_benzo1']
['Codeine']
['Hydrocodone']
['Oxycodone']
['Morphine']
['HMFO']
['Medicaid']
[]
['Medicare']
['CashCredit']
[]
[]
[]
[]
['num_prior_prescriptions1']
['diff_MME1']
['diff_days1']
['switch_drug']
['switch_payment']
['ever_switch_drug']
['ever_switch_payment']
['age30', 'age40', 'age50', 'age60', 'age70', 'age80']
['patient_gender']
[]
[]
['patient_zip_yr_num_prescriptions_per_pop_quartile_0.0', 'patient_zip_yr_num_prescriptions_per_pop_quartile_1.0']
['patient_zip_yr_num_patients_per_pop_quartile_0.0', 'patient_zip_yr_num_patients_per_pop_quartile_1.0']
['prescriber_yr_num_prescriptions_quartile_0.0', 'prescriber_yr_num_prescriptions_quartile_1.0']
['prescriber_yr_num_patients_quartile_0.0', 'prescriber_yr_num_patients_quartile_1.0']
['prescriber_yr_num_pharmacies_quartile_0.0', 'prescriber_yr_num_pharmacies_quartile_1.0']
['prescriber_yr_avg_MME_quartile_0.0', 'prescriber_yr_avg_MME_quartile_1.0']
['prescriber_yr_avg_days_quartile_0.0', 'prescriber_yr_avg_days_quartile_1.0']
['pharmacy_yr_num_prescriptions_quartile_0.0', 'pharmacy_yr_num_prescriptions_quartile_1.0']
['pharmacy_yr_num_patients_quartile_0.0', 'pharmacy_yr_num_patients_quartile_1.0']
['pharmacy_yr_num_prescribers_quartile_0.0', 'pharmacy_yr_num_prescribers_quartile_1.0']
['pharmacy_yr_avg_MME_quartile_0.0', 'pharmacy_yr_avg_MME_quartile_1.0']
['pharmacy_yr_avg_days_quartile_0.0', 'pharmacy_yr_avg_days_quartile_1.0']
['patient_HPIQuartile_0.0', 'patient_HPIQuartile_1.0']
['zip_pop_density_quartile_0.0', 'zip_pop_density_quartile_1.0']
['median_household_income_quartile_0.0', 'median_household_income_quartile_1.0']
['family_poverty_pct_quartile_0.0', 'family_poverty_pct_quartile_1.0']
['unemployment_pct_quartile_0.0', 'unemployment_pct_quartile_1.0']
['Codeine', 'Hydrocodone', 'Oxycodone', 'Morphine', 'HMFO']
['Medicaid', 'Medicare', 'CashCredit']
------------------------------------------------------------
Two cutoffs
Essential cutoffs with lower bound: 4.0
['concurrent_MME10', 'concurrent_MME15', 'concurrent_MME20', 'concurrent_MME25', 'concurrent_MME30', 'concurrent_MME35', 'concurrent_MME40', 'concurrent_MME45', 'concurrent_MME50', 'concurrent_MME75', 'concurrent_MME100', 'concurrent_MME200', 'concurrent_MME300', 'num_prescribers_past1802', 'num_prescribers_past1803', 'num_pharmacies_past1802', 'num_pharmacies_past1803', 'concurrent_benzo1', 'num_prior_prescriptions1', 'diff_MME1', 'diff_days1', 'age30', 'age40', 'age50', 'age60', 'age70', 'age80', 'Codeine', 'Hydrocodone', 'Oxycodone', 'Morphine', 'HMFO', 'Medicaid', 'Medicare', 'CashCredit', 'switch_drug', 'switch_payment', 'ever_switch_drug', 'ever_switch_payment', 'patient_gender', 'patient_HPIQuartile_0.0', 'patient_HPIQuartile_1.0', 'patient_zip_yr_num_prescriptions_per_pop_quartile_0.0', 'patient_zip_yr_num_prescriptions_per_pop_quartile_1.0', 'patient_zip_yr_num_patients_per_pop_quartile_0.0', 'patient_zip_yr_num_patients_per_pop_quartile_1.0', 'prescriber_yr_num_prescriptions_quartile_0.0', 'prescriber_yr_num_prescriptions_quartile_1.0', 'prescriber_yr_num_patients_quartile_0.0', 'prescriber_yr_num_patients_quartile_1.0', 'prescriber_yr_num_pharmacies_quartile_0.0', 'prescriber_yr_num_pharmacies_quartile_1.0', 'prescriber_yr_avg_MME_quartile_0.0', 'prescriber_yr_avg_MME_quartile_1.0', 'prescriber_yr_avg_days_quartile_0.0', 'prescriber_yr_avg_days_quartile_1.0', 'pharmacy_yr_num_prescriptions_quartile_0.0', 'pharmacy_yr_num_prescriptions_quartile_1.0', 'pharmacy_yr_num_patients_quartile_0.0', 'pharmacy_yr_num_patients_quartile_1.0', 'pharmacy_yr_num_prescribers_quartile_0.0', 'pharmacy_yr_num_prescribers_quartile_1.0', 'pharmacy_yr_avg_MME_quartile_0.0', 'pharmacy_yr_avg_MME_quartile_1.0', 'pharmacy_yr_avg_days_quartile_0.0', 'pharmacy_yr_avg_days_quartile_1.0', 'zip_pop_density_quartile_0.0', 'zip_pop_density_quartile_1.0', 'median_household_income_quartile_0.0', 'median_household_income_quartile_1.0', 'family_poverty_pct_quartile_0.0', 'family_poverty_pct_quartile_1.0', 'unemployment_pct_quartile_0.0', 'unemployment_pct_quartile_1.0']
['patient_HPIQuartile_0.0', 'patient_HPIQuartile_1.0', 'patient_zip_yr_num_prescriptions_per_pop_quartile_0.0', 'patient_zip_yr_num_prescriptions_per_pop_quartile_1.0', 'patient_zip_yr_num_patients_per_pop_quartile_0.0', 'patient_zip_yr_num_patients_per_pop_quartile_1.0', 'prescriber_yr_num_prescriptions_quartile_0.0', 'prescriber_yr_num_prescriptions_quartile_1.0', 'prescriber_yr_num_patients_quartile_0.0', 'prescriber_yr_num_patients_quartile_1.0', 'prescriber_yr_num_pharmacies_quartile_0.0', 'prescriber_yr_num_pharmacies_quartile_1.0', 'prescriber_yr_avg_MME_quartile_0.0', 'prescriber_yr_avg_MME_quartile_1.0', 'prescriber_yr_avg_days_quartile_0.0', 'prescriber_yr_avg_days_quartile_1.0', 'pharmacy_yr_num_prescriptions_quartile_0.0', 'pharmacy_yr_num_prescriptions_quartile_1.0', 'pharmacy_yr_num_patients_quartile_0.0', 'pharmacy_yr_num_patients_quartile_1.0', 'pharmacy_yr_num_prescribers_quartile_0.0', 'pharmacy_yr_num_prescribers_quartile_1.0', 'pharmacy_yr_avg_MME_quartile_0.0', 'pharmacy_yr_avg_MME_quartile_1.0', 'pharmacy_yr_avg_days_quartile_0.0', 'pharmacy_yr_avg_days_quartile_1.0', 'zip_pop_density_quartile_0.0', 'zip_pop_density_quartile_1.0', 'median_household_income_quartile_0.0', 'median_household_income_quartile_1.0', 'family_poverty_pct_quartile_0.0', 'family_poverty_pct_quartile_1.0', 'unemployment_pct_quartile_0.0', 'unemployment_pct_quartile_1.0']
------------------------------------------------------------
setting c0_value = 0.0 for (Intercept) to ensure that intercept is not penalized
08/11/24 @ 01:36 AM | switching loss computation from lookup to weighted
08/11/24 @ 01:36 AM | ------------------------------------------------------------
08/11/24 @ 01:36 AM | runnning initialization procedure
08/11/24 @ 01:36 AM | ------------------------------------------------------------
08/11/24 @ 01:41 AM | CPA produced 2 cuts
08/11/24 @ 01:41 AM | running naive rounding on 4 solutions
08/11/24 @ 01:41 AM | best objective value: 0.3468
08/11/24 @ 01:42 AM | rounding produced 0 integer solutions
08/11/24 @ 01:42 AM | running sequential rounding on 4 solutions
08/11/24 @ 01:42 AM | best objective value: 0.3468
08/11/24 @ 01:42 AM | sequential rounding produced 0 integer solutions
08/11/24 @ 01:42 AM | initialization produced 0 feasible solutions
08/11/24 @ 01:42 AM | ------------------------------------------------------------
08/11/24 @ 01:42 AM | completed initialization procedure
08/11/24 @ 01:42 AM | ------------------------------------------------------------
08/11/24 @ 01:42 AM | switching loss computation from lookup to weighted
register_callback

08/11/24 @ 01:42 AM | adding 546 initial cuts
/mnt/phd/jihu/opioid/Code/risk_test.py:36: DtypeWarning: Columns (2) have mixed types. Specify dtype option on import or set low_memory=False.
  FULL = pd.read_csv(file_path, delimiter=",", dtype={'concurrent_MME': float,
+------------------------------------------------+------------------+-----------+
| Pr(Y = +1) = 1.0/(1.0 + exp(-(-8 + score)))    |                  |           |
| ============================================== | ================ | ========= |
| num_prior_prescriptions1                       |         2 points |   + ..... |
| prescriber_yr_avg_days_quartile_1.0            |         2 points |   + ..... |
| concurrent_MME40                               |         1 points |   + ..... |
| age30                                          |         1 points |   + ..... |
| HMFO                                           |         1 points |   + ..... |
| prescriber_yr_num_prescriptions_quartile_0.0   |         1 points |   + ..... |
| prescriber_yr_num_patients_quartile_1.0        |         1 points |   + ..... |
| pharmacy_yr_avg_days_quartile_1.0              |         1 points |   + ..... |
| ============================================== | ================ | ========= |
| ADD POINTS FROM ROWS 1 to 8                    |            SCORE |   = ..... |
+------------------------------------------------+------------------+-----------+
-8 ['num_prior_prescriptions1', 'prescriber_yr_avg_days_quartile_1.0', 'concurrent_MME40', 'age30', 'HMFO', 'prescriber_yr_num_prescriptions_quartile_0.0', 'prescriber_yr_num_patients_quartile_1.0', 'pharmacy_yr_avg_days_quartile_1.0'] [2. 2. 1. 1. 1. 1. 1. 1.]
{'intercept': -8, 'conditions': ['num_prior_prescriptions', 'prescriber_yr_avg_days_quartile', 'concurrent_MME', 'age', 'HMFO', 'prescriber_yr_num_prescriptions_quartile', 'prescriber_yr_num_patients_quartile', 'pharmacy_yr_avg_days_quartile'], 'cutoffs': [1, '1', 40, 30, 1, '0', '1', '1'], 'scores': [2, 2, 1, 1, 1, 1, 1, 1]}
Finished riskSLIM in 7537.5 seconds

                         Train
Train accuracy           0.895
Train Recall             0.275
Train Precision          0.434
Train ROC AUC            0.854
Train PR AUC              0.32
Train Calibration error  0.016
Start testing with table:
Intercept: -8

 - Condition: num_prior_prescriptions, Cutoff: 1, Score: 2
 - Condition: prescriber_yr_avg_days_quartile, Cutoff: 1, Score: 2
 - Condition: concurrent_MME, Cutoff: 40, Score: 1
 - Condition: age, Cutoff: 30, Score: 1
 - Condition: HMFO, Cutoff: 1, Score: 1
 - Condition: prescriber_yr_num_prescriptions_quartile, Cutoff: 0, Score: 1
 - Condition: prescriber_yr_num_patients_quartile, Cutoff: 1, Score: 1
 - Condition: pharmacy_yr_avg_days_quartile, Cutoff: 1, Score: 1
WARNING: Encoding quartile values to binary

0: Accuracy = 0.895, ROC AUC = 0.844, Calibration = 0.018
1: Accuracy = 0.897, ROC AUC = 0.849, Calibration = 0.017
----------------------------------------------------------------------------------------------------
Total prescriptions from true positive patients: 
 (285148, 122)
----------------------------------------------------------------------------------------------------
Proportion of LT users detected within a month: 0.5192571465894494
1
{'test_accuracy': 0.9742887581638797, 'test_roc_auc': 0.8311315285557713, 'test_pr_auc': 0.09561282990334184, 'test_calibration_error': 0.007862002848732357}
2
{'test_accuracy': 0.8590918320841474, 'test_roc_auc': 0.7526112929083283, 'test_pr_auc': 0.19999241773436563, 'test_calibration_error': 0.06710653513363962}
3
{'test_accuracy': 0.7675201799154943, 'test_roc_auc': 0.703769697505397, 'test_pr_auc': 0.32571350034933383, 'test_calibration_error': 0.0352045116248736}


Test done!

                   Value
Accuracy           0.896
Recall             0.257
Precision          0.431
ROC AUC            0.847
PR AUC             0.311
Calibration error  0.018
        Prob  Num_presc       TN      FP      FN      TP  Accuracy  \
0   0.000335       8817     8803       0      14       0    0.9984   
1   0.000911     289159   288650       0     509       0    0.9982   
2   0.002473    1224818  1220789       0    4029       0    0.9967   
3   0.006693     977729   969942       0    7787       0    0.9920   
4   0.017986     960168   923808       0   36360       0    0.9621   
5   0.047426     977089   908228       0   68861       0    0.9295   
6   0.119203     702121   584942       0  117179       0    0.8331   
7   0.268941     811631   596068       0  215563       0    0.7344   
8   0.500000     334860        0  194192       0  140668    0.4201   
9   0.731059      26420        0   11246       0   15174    0.5743   
10  0.880797         26        0      10       0      16    0.6154   

    Observed Risk  Num_patients  Num_longterm  
0        0.001588          8817            16  
1        0.001760        289159           613  
2        0.003289       1224281          5418  
3        0.007964        962393          8220  
4        0.037868        828569         31389  
5        0.070476        824844         59603  
6        0.166893        456775         56355  
7        0.265592        401438         72493  
8        0.420080        154913         44773  
9        0.574338         11984          5093  
10       0.615385            17             7  
