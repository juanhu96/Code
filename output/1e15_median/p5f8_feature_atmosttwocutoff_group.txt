/mnt/phd/jihu/opioid/Code/risk_train.py:70: DtypeWarning: Columns (2) have mixed types. Specify dtype option on import or set low_memory=False.
  FULL = pd.read_csv(file_path, delimiter=",", dtype={'concurrent_MME': float,
Start single training, file saved with setting tag _single_p5_f8_median_featureatmosttwocutoff_group_essential1.0

/export/storage_cures/CURES/Processed/FULL_OPIOID_2018_INPUT.csv
FULL_2018_Explore_STUMPS_median_
Finished importing STUMPS, with shape (6263383, 146)

Single cutoffs:
['concurrent_MME10', 'concurrent_MME15', 'concurrent_MME20', 'concurrent_MME25', 'concurrent_MME30', 'concurrent_MME35', 'concurrent_MME40', 'concurrent_MME45', 'concurrent_MME50', 'concurrent_MME75', 'concurrent_MME100', 'concurrent_MME200', 'concurrent_MME300']
['num_prescribers_past1802', 'num_prescribers_past1803']
['num_pharmacies_past1802', 'num_pharmacies_past1803']
['concurrent_benzo1']
['Codeine']
['Hydrocodone']
['Oxycodone']
['Morphine']
['HMFO']
['Medicaid']
[]
['Medicare']
['CashCredit']
[]
[]
[]
[]
['num_prior_prescriptions1']
['diff_MME1']
['diff_days1']
['switch_drug']
['switch_payment']
['ever_switch_drug']
['ever_switch_payment']
['age30', 'age40', 'age50', 'age60', 'age70', 'age80']
['patient_gender']
[]
[]
['patient_zip_yr_num_prescriptions_per_pop_quartile_0.0', 'patient_zip_yr_num_prescriptions_per_pop_quartile_1.0']
['patient_zip_yr_num_patients_per_pop_quartile_0.0', 'patient_zip_yr_num_patients_per_pop_quartile_1.0']
['prescriber_yr_num_prescriptions_quartile_0.0', 'prescriber_yr_num_prescriptions_quartile_1.0']
['prescriber_yr_num_patients_quartile_0.0', 'prescriber_yr_num_patients_quartile_1.0']
['prescriber_yr_num_pharmacies_quartile_0.0', 'prescriber_yr_num_pharmacies_quartile_1.0']
['prescriber_yr_avg_MME_quartile_0.0', 'prescriber_yr_avg_MME_quartile_1.0']
['prescriber_yr_avg_days_quartile_0.0', 'prescriber_yr_avg_days_quartile_1.0']
['pharmacy_yr_num_prescriptions_quartile_0.0', 'pharmacy_yr_num_prescriptions_quartile_1.0']
['pharmacy_yr_num_patients_quartile_0.0', 'pharmacy_yr_num_patients_quartile_1.0']
['pharmacy_yr_num_prescribers_quartile_0.0', 'pharmacy_yr_num_prescribers_quartile_1.0']
['pharmacy_yr_avg_MME_quartile_0.0', 'pharmacy_yr_avg_MME_quartile_1.0']
['pharmacy_yr_avg_days_quartile_0.0', 'pharmacy_yr_avg_days_quartile_1.0']
['patient_HPIQuartile_0.0', 'patient_HPIQuartile_1.0']
['zip_pop_density_quartile_0.0', 'zip_pop_density_quartile_1.0']
['median_household_income_quartile_0.0', 'median_household_income_quartile_1.0']
['family_poverty_pct_quartile_0.0', 'family_poverty_pct_quartile_1.0']
['unemployment_pct_quartile_0.0', 'unemployment_pct_quartile_1.0']
------------------------------------------------------------
Two cutoffs
['patient_zip_yr_num_prescriptions_per_pop_quartile_0.0', 'patient_zip_yr_num_prescriptions_per_pop_quartile_1.0', 'patient_zip_yr_num_patients_per_pop_quartile_0.0', 'patient_zip_yr_num_patients_per_pop_quartile_1.0']
['prescriber_yr_num_prescriptions_quartile_0.0', 'prescriber_yr_num_prescriptions_quartile_1.0', 'prescriber_yr_num_patients_quartile_0.0', 'prescriber_yr_num_patients_quartile_1.0', 'prescriber_yr_num_pharmacies_quartile_0.0', 'prescriber_yr_num_pharmacies_quartile_1.0', 'prescriber_yr_avg_MME_quartile_0.0', 'prescriber_yr_avg_MME_quartile_1.0', 'prescriber_yr_avg_days_quartile_0.0', 'prescriber_yr_avg_days_quartile_1.0']
['pharmacy_yr_num_prescriptions_quartile_0.0', 'pharmacy_yr_num_prescriptions_quartile_1.0', 'pharmacy_yr_num_patients_quartile_0.0', 'pharmacy_yr_num_patients_quartile_1.0', 'pharmacy_yr_num_prescribers_quartile_0.0', 'pharmacy_yr_num_prescribers_quartile_1.0', 'pharmacy_yr_avg_MME_quartile_0.0', 'pharmacy_yr_avg_MME_quartile_1.0', 'pharmacy_yr_avg_days_quartile_0.0', 'pharmacy_yr_avg_days_quartile_1.0']
['patient_HPIQuartile_0.0', 'patient_HPIQuartile_1.0', 'zip_pop_density_quartile_0.0', 'zip_pop_density_quartile_1.0', 'median_household_income_quartile_0.0', 'median_household_income_quartile_1.0', 'family_poverty_pct_quartile_0.0', 'family_poverty_pct_quartile_1.0', 'unemployment_pct_quartile_0.0', 'unemployment_pct_quartile_1.0']
['Codeine', 'Hydrocodone', 'Oxycodone', 'Morphine', 'HMFO']
['Medicaid', 'Medicare', 'CashCredit']
------------------------------------------------------------
Essential cutoffs with lower bound: 1.0
['concurrent_MME10', 'concurrent_MME15', 'concurrent_MME20', 'concurrent_MME25', 'concurrent_MME30', 'concurrent_MME35', 'concurrent_MME40', 'concurrent_MME45', 'concurrent_MME50', 'concurrent_MME75', 'concurrent_MME100', 'concurrent_MME200', 'concurrent_MME300', 'num_prescribers_past1802', 'num_prescribers_past1803', 'num_pharmacies_past1802', 'num_pharmacies_past1803', 'concurrent_benzo1', 'num_prior_prescriptions1', 'diff_MME1', 'diff_days1', 'age30', 'age40', 'age50', 'age60', 'age70', 'age80', 'Codeine', 'Hydrocodone', 'Oxycodone', 'Morphine', 'HMFO', 'Medicaid', 'Medicare', 'CashCredit', 'switch_drug', 'switch_payment', 'ever_switch_drug', 'ever_switch_payment', 'patient_gender', 'patient_HPIQuartile_0.0', 'patient_HPIQuartile_1.0', 'patient_zip_yr_num_prescriptions_per_pop_quartile_0.0', 'patient_zip_yr_num_prescriptions_per_pop_quartile_1.0', 'patient_zip_yr_num_patients_per_pop_quartile_0.0', 'patient_zip_yr_num_patients_per_pop_quartile_1.0', 'prescriber_yr_num_prescriptions_quartile_0.0', 'prescriber_yr_num_prescriptions_quartile_1.0', 'prescriber_yr_num_patients_quartile_0.0', 'prescriber_yr_num_patients_quartile_1.0', 'prescriber_yr_num_pharmacies_quartile_0.0', 'prescriber_yr_num_pharmacies_quartile_1.0', 'prescriber_yr_avg_MME_quartile_0.0', 'prescriber_yr_avg_MME_quartile_1.0', 'prescriber_yr_avg_days_quartile_0.0', 'prescriber_yr_avg_days_quartile_1.0', 'pharmacy_yr_num_prescriptions_quartile_0.0', 'pharmacy_yr_num_prescriptions_quartile_1.0', 'pharmacy_yr_num_patients_quartile_0.0', 'pharmacy_yr_num_patients_quartile_1.0', 'pharmacy_yr_num_prescribers_quartile_0.0', 'pharmacy_yr_num_prescribers_quartile_1.0', 'pharmacy_yr_avg_MME_quartile_0.0', 'pharmacy_yr_avg_MME_quartile_1.0', 'pharmacy_yr_avg_days_quartile_0.0', 'pharmacy_yr_avg_days_quartile_1.0', 'zip_pop_density_quartile_0.0', 'zip_pop_density_quartile_1.0', 'median_household_income_quartile_0.0', 'median_household_income_quartile_1.0', 'family_poverty_pct_quartile_0.0', 'family_poverty_pct_quartile_1.0', 'unemployment_pct_quartile_0.0', 'unemployment_pct_quartile_1.0']
------------------------------------------------------------
setting c0_value = 0.0 for (Intercept) to ensure that intercept is not penalized
08/08/24 @ 09:53 AM | switching loss computation from lookup to weighted
08/08/24 @ 09:54 AM | ------------------------------------------------------------
08/08/24 @ 09:54 AM | runnning initialization procedure
08/08/24 @ 09:54 AM | ------------------------------------------------------------
08/08/24 @ 09:59 AM | CPA produced 2 cuts
08/08/24 @ 09:59 AM | running naive rounding on 4 solutions
08/08/24 @ 09:59 AM | best objective value: 0.4222
08/08/24 @ 09:59 AM | rounding produced 0 integer solutions
08/08/24 @ 09:59 AM | running sequential rounding on 4 solutions
08/08/24 @ 09:59 AM | best objective value: 0.4222
08/08/24 @ 09:59 AM | sequential rounding produced 0 integer solutions
08/08/24 @ 09:59 AM | initialization produced 0 feasible solutions
08/08/24 @ 09:59 AM | ------------------------------------------------------------
08/08/24 @ 09:59 AM | completed initialization procedure
08/08/24 @ 09:59 AM | ------------------------------------------------------------
08/08/24 @ 09:59 AM | switching loss computation from lookup to weighted
register_callback

08/08/24 @ 09:59 AM | adding 305 initial cuts
/mnt/phd/jihu/opioid/Code/risk_test.py:36: DtypeWarning: Columns (2) have mixed types. Specify dtype option on import or set low_memory=False.
  FULL = pd.read_csv(file_path, delimiter=",", dtype={'concurrent_MME': float,
+-----------------------------------------------+------------------+-----------+
| Pr(Y = +1) = 1.0/(1.0 + exp(-(-8 + score)))   |                  |           |
| ============================================= | ================ | ========= |
| num_prior_prescriptions1                      |         2 points |   + ..... |
| prescriber_yr_avg_days_quartile_1.0           |         2 points |   + ..... |
| concurrent_MME75                              |         1 points |   + ..... |
| age30                                         |         1 points |   + ..... |
| HMFO                                          |         1 points |   + ..... |
| Medicare                                      |         1 points |   + ..... |
| prescriber_yr_num_patients_quartile_1.0       |         1 points |   + ..... |
| pharmacy_yr_avg_days_quartile_1.0             |         1 points |   + ..... |
| ============================================= | ================ | ========= |
| ADD POINTS FROM ROWS 1 to 8                   |            SCORE |   = ..... |
+-----------------------------------------------+------------------+-----------+
-8 ['num_prior_prescriptions1', 'prescriber_yr_avg_days_quartile_1.0', 'concurrent_MME75', 'age30', 'HMFO', 'Medicare', 'prescriber_yr_num_patients_quartile_1.0', 'pharmacy_yr_avg_days_quartile_1.0'] [2. 2. 1. 1. 1. 1. 1. 1.]
{'intercept': -8, 'conditions': ['num_prior_prescriptions', 'prescriber_yr_avg_days_quartile', 'concurrent_MME', 'age', 'HMFO', 'Medicare', 'prescriber_yr_num_patients_quartile', 'pharmacy_yr_avg_days_quartile'], 'cutoffs': [1, '1', 75, 30, 1, 1, '1', '1'], 'scores': [2, 2, 1, 1, 1, 1, 1, 1]}
Finished riskSLIM in 7542.3 seconds

Start testing with table:
Intercept: -8

 - Condition: num_prior_prescriptions, Cutoff: 1, Score: 2
 - Condition: prescriber_yr_avg_days_quartile, Cutoff: 1, Score: 2
 - Condition: concurrent_MME, Cutoff: 75, Score: 1
 - Condition: age, Cutoff: 30, Score: 1
 - Condition: HMFO, Cutoff: 1, Score: 1
 - Condition: Medicare, Cutoff: 1, Score: 1
 - Condition: prescriber_yr_num_patients_quartile, Cutoff: 1, Score: 1
 - Condition: pharmacy_yr_avg_days_quartile, Cutoff: 1, Score: 1
WARNING: Encoding quartile values to binary

0: Accuracy = 0.895, ROC AUC = 0.843, Calibration = 0.022
1: Accuracy = 0.894, ROC AUC = 0.848, Calibration = 0.025
----------------------------------------------------------------------------------------------------
Total prescriptions from true positive patients: 
 (248305, 122)
----------------------------------------------------------------------------------------------------
Proportion of LT users detected within a month: 0.5056348610067618
1
{'test_accuracy': 0.9742916696995163, 'test_roc_auc': 0.8328110169706355, 'test_pr_auc': 0.09533135763034876, 'test_calibration_error': 0.009004622780666093}
2
{'test_accuracy': 0.8597001051391854, 'test_roc_auc': 0.752925872691717, 'test_pr_auc': 0.19822264236652773, 'test_calibration_error': 0.058941989216266304}
3
{'test_accuracy': 0.7639120261695265, 'test_roc_auc': 0.7031991605579446, 'test_pr_auc': 0.3231569106223739, 'test_calibration_error': 0.05094557495508627}


Test done!

                   Value
Accuracy           0.895
Recall             0.222
Precision          0.412
ROC AUC            0.846
PR AUC             0.309
Calibration error  0.024
        Prob  Num_presc       TN      FP      FN      TP  Accuracy  \
0   0.000335      21167    21134       0      33       0    0.9984   
1   0.000911     381783   381033       0     750       0    0.9980   
2   0.002473    1263823  1259332       0    4491       0    0.9964   
3   0.006693     943027   933950       0    9077       0    0.9904   
4   0.017986     990074   949109       0   40965       0    0.9586   
5   0.047426     908977   837781       0   71196       0    0.9217   
6   0.119203     706279   582584       0  123695       0    0.8249   
7   0.268941     771202   549687       0  221515       0    0.7128   
8   0.500000     280584        0  172389       0  108195    0.3856   
9   0.731059      42554        0   18657       0   23897    0.5616   
10  0.880797       3368        0    1022       0    2346    0.6966   

    Observed Risk  Num_patients  Num_longterm  
0        0.001559         21167            41  
1        0.001964        381783           959  
2        0.003554       1262648          5833  
3        0.009625        919248          8934  
4        0.041376        831172         33093  
5        0.078325        760175         61856  
6        0.175136        428493         51831  
7        0.287233        377507         72986  
8        0.385606        133959         36436  
9        0.561569         20304          8445  
10       0.696556          1602           921  
