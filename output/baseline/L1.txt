/mnt/phd/jihu/opioid/Code/baseline_main.py:93: DtypeWarning: Columns (2) have mixed types. Specify dtype option on import or set low_memory=False.
  FULL = pd.read_csv(file_path, delimiter=",", dtype={'concurrent_MME': float,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/statsmodels/base/l1_solvers_common.py:71: ConvergenceWarning: QC check did not pass for 66 out of 66 parameters
Try increasing solver accuracy or number of iterations, decreasing alpha, or switch solvers
  warnings.warn(message, ConvergenceWarning)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/statsmodels/base/l1_solvers_common.py:144: ConvergenceWarning: Could not trim params automatically due to failed QC check. Trimming using trim_mode == 'size' will still work.
  warnings.warn(msg, ConvergenceWarning)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/statsmodels/base/model.py:607: ConvergenceWarning: Maximum Likelihood optimization failed to converge. Check mle_retvals
  warnings.warn("Maximum Likelihood optimization failed to "
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/pandas/core/arraylike.py:399: RuntimeWarning: overflow encountered in exp
  result = getattr(ufunc, method)(*inputs, **kwargs)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/mnt/phd/jihu/opioid/Code/baseline_main.py:323: DtypeWarning: Columns (2) have mixed types. Specify dtype option on import or set low_memory=False.
  FULL_TEST = pd.read_csv(test_file_path, delimiter=",", dtype={'concurrent_MME': float,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/mnt/phd/jihu/opioid/Code/utils/model_selection.py:323: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  test_results_by_MME = FULL.groupby('MME_bins').apply(lambda x: {'test_accuracy': accuracy_score(x['long_term_180'], x['Pred']),
/mnt/phd/jihu/opioid/Code/baseline_main.py:323: DtypeWarning: Columns (2) have mixed types. Specify dtype option on import or set low_memory=False.
  FULL_TEST = pd.read_csv(test_file_path, delimiter=",", dtype={'concurrent_MME': float,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
============================================================ 
Baseline train with model L1

Filtered columns: ['num_prescribers_past1802', 'num_prescribers_past1803', 'num_prescribers_past1804', 'num_prescribers_past1805', 'num_prescribers_past1806', 'num_pharmacies_past1802', 'num_pharmacies_past1803', 'num_pharmacies_past1804', 'num_pharmacies_past1805', 'num_pharmacies_past1806', 'concurrent_benzo1', 'days_supply3', 'days_supply5', 'days_supply7', 'days_supply10', 'daily_dose25', 'daily_dose50', 'daily_dose75', 'daily_dose90', 'num_prior_prescriptions1', 'diff_MME1', 'diff_days1', 'patient_gender', 'Hydrocodone', 'Oxycodone', 'Codeine', 'Morphine', 'HMFO', 'long_acting', 'CashCredit', 'Medicare', 'Medicaid', 'Other', 'switch_drug', 'switch_payment', 'ever_switch_drug', 'ever_switch_payment', 'prescriber_yr_num_prescriptions_above50', 'prescriber_yr_num_prescriptions_above75', 'prescriber_yr_num_patients_above50', 'prescriber_yr_num_patients_above75', 'prescriber_yr_num_pharmacies_above50', 'prescriber_yr_num_pharmacies_above75', 'prescriber_yr_avg_MME_above50', 'prescriber_yr_avg_MME_above75', 'prescriber_yr_avg_days_above50', 'prescriber_yr_avg_days_above75', 'pharmacy_yr_num_prescriptions_above50', 'pharmacy_yr_num_prescriptions_above75', 'pharmacy_yr_num_patients_above50', 'pharmacy_yr_num_patients_above75', 'pharmacy_yr_num_prescribers_above50', 'pharmacy_yr_num_prescribers_above75', 'pharmacy_yr_avg_MME_above50', 'pharmacy_yr_avg_MME_above75', 'pharmacy_yr_avg_days_above50', 'pharmacy_yr_avg_days_above75', 'zip_pop_density_above50', 'zip_pop_density_above75', 'median_household_income_above50', 'median_household_income_above75', 'family_poverty_pct_above50', 'family_poverty_pct_above75', 'unemployment_pct_above50', 'unemployment_pct_above75']
GridSearchCV for Lasso: 985.0s


Fitting for Lasso: 111.0s

Optimization terminated successfully    (Exit mode 0)
            Current function value: 0.19375819919707057
            Iterations: 333
            Function evaluations: 334
            Gradient evaluations: 333
36 features selected: ['num_prescribers_past1802', 'num_prescribers_past1803', 'num_prescribers_past1804', 'concurrent_benzo1', 'days_supply5', 'days_supply7', 'days_supply10', 'daily_dose25', 'daily_dose50', 'daily_dose90', 'num_prior_prescriptions1', 'diff_days1', 'Hydrocodone', 'Codeine', 'HMFO', 'long_acting', 'CashCredit', 'Medicare', 'ever_switch_drug', 'ever_switch_payment', 'prescriber_yr_num_prescriptions_above50', 'prescriber_yr_num_patients_above50', 'prescriber_yr_avg_MME_above50', 'prescriber_yr_avg_MME_above75', 'prescriber_yr_avg_days_above50', 'prescriber_yr_avg_days_above75', 'pharmacy_yr_avg_MME_above50', 'pharmacy_yr_avg_MME_above75', 'pharmacy_yr_avg_days_above50', 'pharmacy_yr_avg_days_above75', 'median_household_income_above50', 'median_household_income_above75', 'family_poverty_pct_above50', 'family_poverty_pct_above75', 'unemployment_pct_above50', 'unemployment_pct_above75']
{'training_accuracy': 0.918, 'training_roc_auc': 0.913, 'training_calibration_error': 0.008}
Finished training and fitting L1: 0.39 hours
Testing on all data for L1 with setting _L1
============================================================ 
Baseline test with model L1

The test file path is /export/storage_cures/CURES/Processed/FULL_OPIOID_2019_INPUT.csv

Optimal threshold for binary classification: 0.0986392466184387
test_accuracy
0.835
test_roc_auc
0.919
test_pr_auc
0.564
test_calibration_error
0.012


0: Accuracy = 0.8314, ROC AUC = 0.9158, Calibration = 0.0100
1: Accuracy = 0.8386, ROC AUC = 0.9222, Calibration = 0.0135
----------------------------------------------------------------------------------------------------
Total prescriptions from true positive patients: 
 (599658, 153)
----------------------------------------------------------------------------------------------------
Proportion of LT users detected within a month: 84.3; two months: 92.7, three months: 95.9
1
{'test_accuracy': 0.935, 'test_recall': 0.681, 'test_precision': 0.233, 'test_roc_auc': 0.917, 'test_pr_auc': 0.307, 'test_calibration_error': 0.009}
2
{'test_accuracy': 0.74, 'test_recall': 0.904, 'test_precision': 0.245, 'test_roc_auc': 0.897, 'test_pr_auc': 0.483, 'test_calibration_error': 0.041}
3
{'test_accuracy': 0.67, 'test_recall': 0.926, 'test_precision': 0.366, 'test_roc_auc': 0.877, 'test_pr_auc': 0.619, 'test_calibration_error': 0.038}


[0, 10)
{'test_accuracy': 0.6362891664960065, 'test_recall': 0.8799900749889722, 'test_roc_auc': 0.8338266811773167, 'test_pr_auc': 0.4202535233311666, 'test_calibration_error': 0.010097017138994873, 'correctly_predicted_positives_ratio': 0.11468000330541693}
[10, 20)
{'test_accuracy': 0.820078507485673, 'test_recall': 0.8612579553924661, 'test_roc_auc': 0.9115083525100678, 'test_pr_auc': 0.46269355165259113, 'test_calibration_error': 0.007973560908682585, 'correctly_predicted_positives_ratio': 0.06968072818429868}
[20, 30)
{'test_accuracy': 0.9029774551542311, 'test_recall': 0.8229655368224653, 'test_roc_auc': 0.9350790622783196, 'test_pr_auc': 0.4826340742841933, 'test_calibration_error': 0.0089460220829728, 'correctly_predicted_positives_ratio': 0.040566460243282795}
[30, 40)
{'test_accuracy': 0.8804796530082115, 'test_recall': 0.842791551882461, 'test_roc_auc': 0.9340451237975135, 'test_pr_auc': 0.5232945905268309, 'test_calibration_error': 0.011711197921161159, 'correctly_predicted_positives_ratio': 0.05511480033903074}
[40, 50)
{'test_accuracy': 0.8160087944845633, 'test_recall': 0.8653015328164763, 'test_roc_auc': 0.9107991252703789, 'test_pr_auc': 0.5613243900411559, 'test_calibration_error': 0.016267578520669235, 'correctly_predicted_positives_ratio': 0.09860748374217458}
[50, 60)
{'test_accuracy': 0.9077171565632429, 'test_recall': 0.7368860774601659, 'test_roc_auc': 0.9199299075052938, 'test_pr_auc': 0.5056988288195046, 'test_calibration_error': 0.011285279966265067, 'correctly_predicted_positives_ratio': 0.037348690618062154}
[60, 70)
{'test_accuracy': 0.763678936366817, 'test_recall': 0.8778802763467912, 'test_roc_auc': 0.8959854693988605, 'test_pr_auc': 0.6026684072794313, 'test_calibration_error': 0.019721780212762583, 'correctly_predicted_positives_ratio': 0.131476879554786}
[70, 80)
{'test_accuracy': 0.8566720251334111, 'test_recall': 0.7936694884063306, 'test_roc_auc': 0.9099130565715297, 'test_pr_auc': 0.5776251745223517, 'test_calibration_error': 0.017463030814187857, 'correctly_predicted_positives_ratio': 0.07914381977934862}
[80, 90)
{'test_accuracy': 0.7630705880056986, 'test_recall': 0.88192881979955, 'test_roc_auc': 0.899752968373595, 'test_pr_auc': 0.6780208136560555, 'test_calibration_error': 0.03682839126231682, 'correctly_predicted_positives_ratio': 0.1682929685213013}
[90, 100)
{'test_accuracy': 0.7342265394878993, 'test_recall': 0.8654735760011214, 'test_roc_auc': 0.8724604689772534, 'test_pr_auc': 0.6222507914438083, 'test_calibration_error': 0.03211040426204806, 'correctly_predicted_positives_ratio': 0.17102650994007332}
above 100
{'test_accuracy': 0.7258882226687553, 'test_recall': 0.8621770743847033, 'test_roc_auc': 0.8690675479484724, 'test_pr_auc': 0.670557236791088, 'test_calibration_error': 0.045987349469782286, 'correctly_predicted_positives_ratio': 0.19600898793152743}


ROC information for L1 saved to ../output/baseline/files/L1_roc_test_info.pkl
Calibration information for L1 saved to ../output/baseline/files/L1_calibration_test_info.pkl
Proportions information for L1 saved to ../output/baseline/files/L1_proportions_test_info.pkl

Finished computing and exporting results: 0.04hours

Testing on naive data for L1 with setting _L1_naive
============================================================ 
Baseline test with model L1

The test file path is /export/storage_cures/CURES/Processed/FULL_OPIOID_2019_INPUT.csv

Subsetting dataset to first prescription only with (3614699, 151) prescriptions.
Subsetting stumps dataset to first prescription only with (3614699, 96) prescriptions.
Optimal threshold for binary classification: 0.03198277077309352
test_accuracy
0.867
test_roc_auc
0.917
test_pr_auc
0.307
test_calibration_error
0.009


/mnt/phd/jihu/opioid/Code/utils/model_selection.py:323: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  test_results_by_MME = FULL.groupby('MME_bins').apply(lambda x: {'test_accuracy': accuracy_score(x['long_term_180'], x['Pred']),
0: Accuracy = 0.8651, ROC AUC = 0.9115, Calibration = 0.0084
1: Accuracy = 0.8693, ROC AUC = 0.9207, Calibration = 0.0103
----------------------------------------------------------------------------------------------------
Total prescriptions from true positive patients: 
 (78081, 153)
----------------------------------------------------------------------------------------------------
Proportion of LT users detected within a month: 100.0; two months: 100.0, three months: 100.0
1
{'test_accuracy': 0.867, 'test_recall': 0.849, 'test_precision': 0.144, 'test_roc_auc': 0.917, 'test_pr_auc': 0.307, 'test_calibration_error': 0.009}


[0, 10)
{'test_accuracy': 0.43385932852245596, 'test_recall': 0.9246916508538899, 'test_roc_auc': 0.7834694091628489, 'test_pr_auc': 0.16328718806449888, 'test_calibration_error': 0.011096825778337137, 'correctly_predicted_positives_ratio': 0.05200149395083301}
[10, 20)
{'test_accuracy': 0.8226081435574458, 'test_recall': 0.8779881531626824, 'test_roc_auc': 0.9086132019883024, 'test_pr_auc': 0.21626616666151816, 'test_calibration_error': 0.00782142215805313, 'correctly_predicted_positives_ratio': 0.023527060867642745}
[20, 30)
{'test_accuracy': 0.9253794222636587, 'test_recall': 0.7821736855872351, 'test_roc_auc': 0.9071006340431171, 'test_pr_auc': 0.23208715973378224, 'test_calibration_error': 0.00662639124475659, 'correctly_predicted_positives_ratio': 0.011298362346726818}
[30, 40)
{'test_accuracy': 0.9109109475097217, 'test_recall': 0.8480051897502433, 'test_roc_auc': 0.929704919732807, 'test_pr_auc': 0.30910935027590236, 'test_calibration_error': 0.009780058569102017, 'correctly_predicted_positives_ratio': 0.017069329788539835}
[40, 50)
{'test_accuracy': 0.846842852625117, 'test_recall': 0.8866377611351991, 'test_roc_auc': 0.9196457154799107, 'test_pr_auc': 0.35544795026469334, 'test_calibration_error': 0.015633649839161216, 'correctly_predicted_positives_ratio': 0.034870309854962825}
[50, 60)
{'test_accuracy': 0.961438199068414, 'test_recall': 0.653644592663173, 'test_roc_auc': 0.8737728150790941, 'test_pr_auc': 0.3257045240797777, 'test_calibration_error': 0.008194351002424851, 'correctly_predicted_positives_ratio': 0.006931323316931222}
[60, 70)
{'test_accuracy': 0.8152301266764994, 'test_recall': 0.8732498157700811, 'test_roc_auc': 0.902632375395298, 'test_pr_auc': 0.36148199731537034, 'test_calibration_error': 0.016938240097721758, 'correctly_predicted_positives_ratio': 0.04083559623416544}
[70, 80)
{'test_accuracy': 0.9504562189851129, 'test_recall': 0.7062445030782761, 'test_roc_auc': 0.8889217463195747, 'test_pr_auc': 0.3559150011044614, 'test_calibration_error': 0.008503907674286569, 'correctly_predicted_positives_ratio': 0.012854170001600768}
[80, 90)
{'test_accuracy': 0.8297061563214497, 'test_recall': 0.8228813559322034, 'test_roc_auc': 0.8869580683301221, 'test_pr_auc': 0.29169312570443684, 'test_calibration_error': 0.01221376398966616, 'correctly_predicted_positives_ratio': 0.02740847376294916}
[90, 100)
{'test_accuracy': 0.8156412359857806, 'test_recall': 0.8681710213776722, 'test_roc_auc': 0.8963739278115519, 'test_pr_auc': 0.4428635980381155, 'test_calibration_error': 0.023287382618589536, 'correctly_predicted_positives_ratio': 0.05996718621821165}
above 100
{'test_accuracy': 0.8362002376708259, 'test_recall': 0.8182060509129682, 'test_roc_auc': 0.8872288823812025, 'test_pr_auc': 0.42285430842030663, 'test_calibration_error': 0.019880364182537132, 'correctly_predicted_positives_ratio': 0.04559566250742721}


ROC information for L1 saved to ../output/baseline/files/L1_roc_test_info_naive.pkl
Calibration information for L1 saved to ../output/baseline/files/L1_calibration_test_info_naive.pkl
Proportions information for L1 saved to ../output/baseline/files/L1_proportions_test_info_naive.pkl

Finished computing and exporting results: 0.03hours

