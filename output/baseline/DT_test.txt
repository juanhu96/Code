/mnt/phd/jihu/opioid/Code/baseline_main.py:93: DtypeWarning: Columns (2) have mixed types. Specify dtype option on import or set low_memory=False.
  FULL = pd.read_csv(file_path, delimiter=",", dtype={'concurrent_MME': float,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/mnt/phd/jihu/opioid/Code/baseline_main.py:318: DtypeWarning: Columns (2) have mixed types. Specify dtype option on import or set low_memory=False.
  FULL_TEST = pd.read_csv(test_file_path, delimiter=",", dtype={'concurrent_MME': float,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/mnt/phd/jihu/opioid/Code/utils/model_selection.py:323: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  test_results_by_MME = FULL.groupby('MME_bins').apply(lambda x: {'test_accuracy': accuracy_score(x['long_term_180'], x['Pred']),
/mnt/phd/jihu/opioid/Code/baseline_main.py:318: DtypeWarning: Columns (2) have mixed types. Specify dtype option on import or set low_memory=False.
  FULL_TEST = pd.read_csv(test_file_path, delimiter=",", dtype={'concurrent_MME': float,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/fromnumeric.py:3504: RuntimeWarning: Mean of empty slice.
  return _methods._mean(a, axis=axis, dtype=dtype,
/users/phd/jihu/anaconda3/lib/python3.9/site-packages/numpy/core/_methods.py:129: RuntimeWarning: invalid value encountered in scalar divide
  ret = ret.dtype.type(ret / rcount)
/mnt/phd/jihu/opioid/Code/utils/model_selection.py:323: FutureWarning: The default of observed=False is deprecated and will be changed to True in a future version of pandas. Pass observed=False to retain current behavior or observed=True to adopt the future default and silence this warning.
  test_results_by_MME = FULL.groupby('MME_bins').apply(lambda x: {'test_accuracy': accuracy_score(x['long_term_180'], x['Pred']),
============================================================ 
Baseline train with model DecisionTree

Filtered columns: ['num_prescribers_past1802', 'num_prescribers_past1803', 'num_prescribers_past1804', 'num_prescribers_past1805', 'num_prescribers_past1806', 'num_pharmacies_past1802', 'num_pharmacies_past1803', 'num_pharmacies_past1804', 'num_pharmacies_past1805', 'num_pharmacies_past1806', 'concurrent_benzo1', 'days_supply3', 'days_supply5', 'days_supply7', 'days_supply10', 'daily_dose25', 'daily_dose50', 'daily_dose75', 'daily_dose90', 'num_prior_prescriptions1', 'diff_MME1', 'diff_days1', 'patient_gender', 'Hydrocodone', 'Oxycodone', 'Codeine', 'Morphine', 'HMFO', 'long_acting', 'CashCredit', 'Medicare', 'Medicaid', 'Other', 'switch_drug', 'switch_payment', 'ever_switch_drug', 'ever_switch_payment', 'prescriber_yr_num_prescriptions_above50', 'prescriber_yr_num_prescriptions_above75', 'prescriber_yr_num_patients_above50', 'prescriber_yr_num_patients_above75', 'prescriber_yr_num_pharmacies_above50', 'prescriber_yr_num_pharmacies_above75', 'prescriber_yr_avg_MME_above50', 'prescriber_yr_avg_MME_above75', 'prescriber_yr_avg_days_above50', 'prescriber_yr_avg_days_above75', 'pharmacy_yr_num_prescriptions_above50', 'pharmacy_yr_num_prescriptions_above75', 'pharmacy_yr_num_patients_above50', 'pharmacy_yr_num_patients_above75', 'pharmacy_yr_num_prescribers_above50', 'pharmacy_yr_num_prescribers_above75', 'pharmacy_yr_avg_MME_above50', 'pharmacy_yr_avg_MME_above75', 'pharmacy_yr_avg_days_above50', 'pharmacy_yr_avg_days_above75', 'zip_pop_density_above50', 'zip_pop_density_above75', 'median_household_income_above50', 'median_household_income_above75', 'family_poverty_pct_above50', 'family_poverty_pct_above75', 'unemployment_pct_above50', 'unemployment_pct_above75']
GridSearchCV for DT: 762.6s


Fitting for DT: 18.2s

4 features selected: ['days_supply10', 'num_prior_prescriptions1', 'diff_days1', 'prescriber_yr_avg_days_above75']
{'training_accuracy': 0.917, 'training_roc_auc': 0.856, 'training_calibration_error': 0.0}
Finished training and fitting DecisionTree: 0.22 hours
Testing on all data for DecisionTree with setting _DecisionTree
============================================================ 
Baseline test with model DecisionTree

The test file path is /export/storage_cures/CURES/Processed/FULL_OPIOID_2019_INPUT.csv

Optimal threshold for binary classification: 0.21981920237086677
test_accuracy
0.863
test_roc_auc
0.858
test_pr_auc
0.465
test_calibration_error
0.005


----------------------------------------------------------------------------------------------------
Total prescriptions from true positive patients: 
 (594424, 153)
----------------------------------------------------------------------------------------------------
Proportion of LT users detected within a month: 81.7; two months: 91.3, three months: 95.1
1
{'test_accuracy': 0.944, 'test_recall': 0.639, 'test_precision': 0.259, 'test_roc_auc': 0.862, 'test_pr_auc': 0.196, 'test_calibration_error': 0.017}
2
{'test_accuracy': 0.78, 'test_recall': 0.873, 'test_precision': 0.275, 'test_roc_auc': 0.866, 'test_pr_auc': 0.397, 'test_calibration_error': 0.035}
3
{'test_accuracy': 0.732, 'test_recall': 0.893, 'test_precision': 0.416, 'test_roc_auc': 0.857, 'test_pr_auc': 0.559, 'test_calibration_error': 0.027}


[0, 10)
{'test_accuracy': 0.6454868483927411, 'test_recall': 0.8662604764005294, 'test_roc_auc': 0.8073645766937656, 'test_pr_auc': 0.36948156727748216, 'test_calibration_error': 0.038466870337680745, 'correctly_predicted_positives_ratio': 0.1128907667489428}
[10, 20)
{'test_accuracy': 0.8330004202776059, 'test_recall': 0.8382661544636202, 'test_roc_auc': 0.8706656814623877, 'test_pr_auc': 0.3938059646479992, 'test_calibration_error': 0.0151192394075804, 'correctly_predicted_positives_ratio': 0.06782055908982529}
[20, 30)
{'test_accuracy': 0.9192269653096751, 'test_recall': 0.7853791760745238, 'test_roc_auc': 0.8767333626809412, 'test_pr_auc': 0.41112192505964973, 'test_calibration_error': 0.01278061613094991, 'correctly_predicted_positives_ratio': 0.03871371484782162}
[30, 40)
{'test_accuracy': 0.903899539837828, 'test_recall': 0.7942804670077397, 'test_roc_auc': 0.8751893141411133, 'test_pr_auc': 0.4463957564917194, 'test_calibration_error': 0.011691764767073235, 'correctly_predicted_positives_ratio': 0.05194239222562702}
[40, 50)
{'test_accuracy': 0.8524613934604509, 'test_recall': 0.8116677516718944, 'test_roc_auc': 0.8627379768240926, 'test_pr_auc': 0.4959240460984825, 'test_calibration_error': 0.013614343705401336, 'correctly_predicted_positives_ratio': 0.09249551929779008}
[50, 60)
{'test_accuracy': 0.9383722407399566, 'test_recall': 0.6420600346124008, 'test_roc_auc': 0.8090645183667328, 'test_pr_auc': 0.4000338248270583, 'test_calibration_error': 0.007805982712207317, 'correctly_predicted_positives_ratio': 0.03254248156460404}
[60, 70)
{'test_accuracy': 0.8230328258587744, 'test_recall': 0.8042610119404178, 'test_roc_auc': 0.8473843772131248, 'test_pr_auc': 0.5354677807192199, 'test_calibration_error': 0.028452738046864802, 'correctly_predicted_positives_ratio': 0.12045119482298199}
[70, 80)
{'test_accuracy': 0.8904670674506177, 'test_recall': 0.7046742730953257, 'test_roc_auc': 0.8231525022598493, 'test_pr_auc': 0.4802230638305829, 'test_calibration_error': 0.024344525477394845, 'correctly_predicted_positives_ratio': 0.07026931800665037}
[80, 90)
{'test_accuracy': 0.8241154544212642, 'test_recall': 0.8067600736346902, 'test_roc_auc': 0.852042412376947, 'test_pr_auc': 0.6189478759533623, 'test_calibration_error': 0.052465283893542235, 'correctly_predicted_positives_ratio': 0.1539489861634238}
[90, 100)
{'test_accuracy': 0.7914662185246402, 'test_recall': 0.780243913835802, 'test_roc_auc': 0.819031108033833, 'test_pr_auc': 0.5489957832250986, 'test_calibration_error': 0.058764853178405504, 'correctly_predicted_positives_ratio': 0.15418424916204213}
above 100
{'test_accuracy': 0.7878594467912038, 'test_recall': 0.7584069150584963, 'test_roc_auc': 0.8094457199696659, 'test_pr_auc': 0.5864506675960262, 'test_calibration_error': 0.0834385240282607, 'correctly_predicted_positives_ratio': 0.17241768109755853}


ROC information for DecisionTree saved to ../output/baseline/files/DecisionTree_roc_test_info.pkl
Calibration information for DecisionTree saved to ../output/baseline/files/DecisionTree_calibration_test_info.pkl
Proportions information for DecisionTree saved to ../output/baseline/files/DecisionTree_proportions_test_info.pkl

Finished computing and exporting results: 0.03hours

Testing on naive data for DecisionTree with setting _DecisionTree_naive
============================================================ 
Baseline test with model DecisionTree

The test file path is /export/storage_cures/CURES/Processed/FULL_OPIOID_2019_FIRST_INPUT.csv

Optimal threshold for binary classification: 0.053759044539588664
test_accuracy
0.885
test_roc_auc
0.862
test_pr_auc
0.197
test_calibration_error
0.017


----------------------------------------------------------------------------------------------------
Total prescriptions from true positive patients: 
 (74802, 153)
----------------------------------------------------------------------------------------------------
Proportion of LT users detected within a month: 100.0; two months: 100.0, three months: 100.0
1
{'test_accuracy': 0.885, 'test_recall': 0.802, 'test_precision': 0.157, 'test_roc_auc': 0.862, 'test_pr_auc': 0.197, 'test_calibration_error': 0.017}


[0, 10)
{'test_accuracy': 0.42922492491895226, 'test_recall': 0.8885895032802249, 'test_roc_auc': 0.7287201805659422, 'test_pr_auc': 0.11285307056709176, 'test_calibration_error': 0.03290678837264861, 'correctly_predicted_positives_ratio': 0.05028607039386888}
[10, 20)
{'test_accuracy': 0.842072918046836, 'test_recall': 0.8203924024212065, 'test_roc_auc': 0.851382948869913, 'test_pr_auc': 0.1508742209661332, 'test_calibration_error': 0.01587504000894849, 'correctly_predicted_positives_ratio': 0.022160703865225933}
[20, 30)
{'test_accuracy': 0.9419699094877995, 'test_recall': 0.7275425916365513, 'test_roc_auc': 0.843689961489775, 'test_pr_auc': 0.1828235418306739, 'test_calibration_error': 0.018276704072189707, 'correctly_predicted_positives_ratio': 0.010598613926168819}
[30, 40)
{'test_accuracy': 0.9240301780128651, 'test_recall': 0.80394416698681, 'test_roc_auc': 0.8777886970155689, 'test_pr_auc': 0.24260041552132625, 'test_calibration_error': 0.020728824553204784, 'correctly_predicted_positives_ratio': 0.01631005206330732}
[40, 50)
{'test_accuracy': 0.8734426471993073, 'test_recall': 0.8442195406773063, 'test_roc_auc': 0.8821322359692648, 'test_pr_auc': 0.2955912856646419, 'test_calibration_error': 0.025570506043245782, 'correctly_predicted_positives_ratio': 0.03341663867566077}
[50, 60)
{'test_accuracy': 0.9763238685753621, 'test_recall': 0.6126463700234192, 'test_roc_auc': 0.7992916322487017, 'test_pr_auc': 0.25521484317852455, 'test_calibration_error': 0.0203518778974402, 'correctly_predicted_positives_ratio': 0.0065722368216099974}
[60, 70)
{'test_accuracy': 0.8435876906653528, 'test_recall': 0.834617061473623, 'test_roc_auc': 0.8686852633819875, 'test_pr_auc': 0.297580071502744, 'test_calibration_error': 0.02605961369575495, 'correctly_predicted_positives_ratio': 0.03929981592111296}
[70, 80)
{'test_accuracy': 0.9597477483201754, 'test_recall': 0.6761658031088082, 'test_roc_auc': 0.8258680681472153, 'test_pr_auc': 0.2848711945486546, 'test_calibration_error': 0.021086404968825998, 'correctly_predicted_positives_ratio': 0.012437850459866884}
[80, 90)
{'test_accuracy': 0.8570268074735987, 'test_recall': 0.7822111388196176, 'test_roc_auc': 0.8441310361426366, 'test_pr_auc': 0.2198003884934566, 'test_calibration_error': 0.017923403260228506, 'correctly_predicted_positives_ratio': 0.02635928177259867}
[90, 100)
{'test_accuracy': 0.8400367607308898, 'test_recall': 0.8233463035019455, 'test_roc_auc': 0.8595027150097622, 'test_pr_auc': 0.35129595422521215, 'test_calibration_error': 0.033790812073414854, 'correctly_predicted_positives_ratio': 0.05719537247269975}
above 100
{'test_accuracy': 0.8642890737529028, 'test_recall': 0.7794426919032598, 'test_roc_auc': 0.849560254556266, 'test_pr_auc': 0.3506316075400702, 'test_calibration_error': 0.02802204916757775, 'correctly_predicted_positives_ratio': 0.04357858843587407}


ROC information for DecisionTree saved to ../output/baseline/files/DecisionTree_roc_test_info_naive.pkl
Calibration information for DecisionTree saved to ../output/baseline/files/DecisionTree_calibration_test_info_naive.pkl
Proportions information for DecisionTree saved to ../output/baseline/files/DecisionTree_proportions_test_info_naive.pkl

Finished computing and exporting results: 0.02hours

